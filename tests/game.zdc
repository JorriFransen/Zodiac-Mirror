
c :: import c;
glfw :: import glfw;
glfw_keys :: import glfw_keys;
gl :: import gl;

using glfw;
using gl;

main :: () -> int
{
    // using glfw_keys;
    // c.printf("GLFW_KEY_ESCAPE: %lu\n", GLFWkey.GLFW_KEY_ESCAPE);
    if (!glfwInit())
    {
        c.printf("glfwInit failed\n");
        return 9;
    }

    width := 640;
    height := 480;

    glfwWindowHint(GLFW_RESIZABLE, GLFW_FALSE);
    window : *GLFWwindow = glfwCreateWindow(width, height, "Triangles!!!", null, null);
    if (!window)
    {
        c.printf("glfwCreateWindow failed\n");
        return 9;
    }

    glfwSetKeyCallback(window, key_callback);
    glfwSetErrorCallback(error_callback);

    glfwMakeContextCurrent(window);
    glfwSwapInterval(1);
    load(*glfwGetProcAddress);
    glViewport(0, 0, width, height);

    vendor := glGetString(GL_VENDOR);
    renderer := glGetString(GL_RENDERER);
    version := glGetString(GL_VERSION);

    c.printf("GL vendor: %s\n", vendor);
    c.printf("GL renderer: %s\n", renderer);
    c.printf("GL version: %s\n", version);

    glViewport(0, 0, width, height);

    // glClearColor(0.1, 0.3, 0.5, 1.0);
    glClearColor(0.0, 0.0, 0.0, 0.0);


    while (!glfwWindowShouldClose(window))
    {
        glClear(GL_COLOR_BUFFER_BIT);

        glBegin(GL_TRIANGLES);
        glColor4f(1.0, 0.0, 0.0, 1.0);
        glVertex2f(-0.5, -0.5);
        glColor4f(0.0, 1.0, 0.0, 1.0);
        glVertex2f(0.5, -0.5);
        glColor4f(0.0, 0.0, 1.0, 1.0);
        glVertex2f(0.0, 0.5);
        glEnd();

        glfwSwapBuffers(window);
        glfwPollEvents();
    }

    glfwDestroyWindow(window);
    glfwTerminate();
}

key_callback :: (window: *GLFWwindow, key: int, scancode: int, action: int, mods: int) -> void
{
    using glfw_keys;
    using GLFWkey;
    // using glfw_keys.GLFWKey;

    if (key == GLFW_KEY_ESCAPE && action == GLFW_PRESS)
    {
        c.printf("Exit requested by user\n");
        glfwSetWindowShouldClose(window, GLFW_TRUE);
    }
    // switch (action)
    // {
    //     case glfw.GLFW_RELEASE:
    //         c.printf("released key: %lu\n", key);

    //     case glfw.GLFW_PRESS:
    //         c.printf("pressed key: %lu\n", key);

    //     case glfw.GLFW_REPEAT:
    //         c.printf("repeat key: %lu\n", key);

    //     default:
    //         c.printf("Unknown action: %lu, key: %lu\n", action, key);
    // }
}

error_callback :: (error: int, description: *u8) -> void
{
    c.fprintf(c.stderr, "GLFW error:%lu:s\n", error, description);
}
