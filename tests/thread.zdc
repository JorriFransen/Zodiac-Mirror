
_c :: import c;

Thread :: struct
{
    handle: u64;
    user_data: *void;
}

Thread_Routine :: typedef *(thread: *Thread) -> *void;

create_thread :: (thread_routine: Thread_Routine, user_data: *void) -> Thread
{
     return __create_thread__(thread_routine, user_data);
}

create_thread :: (thread_routine: Thread_Routine, user_data: $T) -> Thread
{
    return __create_thread__(thread_routine, (:*void)user_data);
}

join_thread :: (thread: Thread)
{
    __join_thread__(thread);
}

compare_and_swap :: (pointer: *u64, old_value: u64, new_value: u64) -> bool
{
    return __compare_and_swap__(pointer, old_value, new_value);
}

_main :: ()
{
    printer_args := (:*void)6;

    t0 : Thread;
    t0.user_data = (:*void)5;

    printer(*t0);

    t1 := create_thread(*printer, printer_args);
    t2 := create_thread(*printer, t0.user_data);


    _c.printf("t1.handle: %d\n", t1.handle);
    _c.printf("t2.handle: %d\n", t2.handle);

    join_thread(t1);
    join_thread(t2);

    t3 := create_thread(*printer, (:*void)3);
    _c.printf("t3.handle: %d\n", t3.handle);

    join_thread(t3);
}

printer :: (thread: *Thread) -> *void
{
    // _c.printf("thread: %p\n", thread);
    count := (:u64)thread.user_data;
    _c.printf("starting printer, handle=%d, data=%ld\n", thread.handle, count);

    // _c.getchar();

    while (count > 0)
    {
        _c.printf("Printer %d: %d\n", thread.handle, count);
        count--;
    }
}
